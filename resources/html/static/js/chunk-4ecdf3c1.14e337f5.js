(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-4ecdf3c1"],{4837:function(e,t,n){"use strict";n.d(t,"b",(function(){return r})),n.d(t,"d",(function(){return o})),n.d(t,"c",(function(){return s})),n.d(t,"a",(function(){return i}));var a=n("d17e");function r(){return Object(a["a"])({url:"/manage/status",method:"get"})}function o(e){return Object(a["a"])({url:"/manage/uploading",method:"get",params:{status:e}})}function s(e){return Object(a["a"])({url:"/manage/uploaded",method:"get",params:{status:e}})}function i(e){return Object(a["a"])({url:"/manage/delsession",method:"delete",data:e})}},9678:function(e,t,n){"use strict";var a=n("d4ec"),r=n("bee2"),o=(n("a434"),n("d3b7"),n("159b"),function(){function e(){Object(a["a"])(this,e),this.timers=[]}return Object(r["a"])(e,[{key:"addTimer",value:function(e,t){var n=setInterval(e,t);return this.timers.push(n),n}},{key:"removeTimer",value:function(e){clearInterval(e);var t=this.timers.indexOf(e);t>=0&&this.timers.splice(t,1)}},{key:"stopAllTimers",value:function(){this.timers.forEach((function(e){return clearInterval(e)})),this.timers=[]}}]),e}());t["a"]=o},cadb:function(e,t,n){"use strict";n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return o}));var a=n("53ca");n("ac1f"),n("00b4"),n("5319"),n("4d63"),n("2c3e"),n("25f0"),n("d3b7"),n("4d90"),n("159b");function r(e,t){if(0===arguments.length||!e)return null;var n,r=t||"{y}-{m}-{d} {h}:{i}:{s}";"object"===Object(a["a"])(e)?n=e:("string"===typeof e&&(e=/^[0-9]+$/.test(e)?parseInt(e):e.replace(new RegExp(/-/gm),"/")),"number"===typeof e&&10===e.toString().length&&(e*=1e3),n=new Date(e));var o={y:n.getFullYear(),m:n.getMonth()+1,d:n.getDate(),h:n.getHours(),i:n.getMinutes(),s:n.getSeconds(),a:n.getDay()},s=r.replace(/{([ymdhisa])+}/g,(function(e,t){var n=o[t];return"a"===t?["日","一","二","三","四","五","六"][n]:n.toString().padStart(2,"0")}));return s}function o(e,t){e=10===(""+e).length?1e3*parseInt(e):+e;var n=new Date(e),a=Date.now(),o=(a-n)/1e3;return o<30?o+"秒":o<3600?Math.ceil(o/60)+"分钟":o<86400?Math.ceil(o/3600)+"小时":o<172800?"1天":t?r(e,t):n.getMonth()+1+"月"+n.getDate()+"日"+n.getHours()+"时"+n.getMinutes()+"分"}},d17e:function(e,t,n){"use strict";var a=n("c7eb"),r=n("1da1"),o=(n("d3b7"),n("bc3a")),s=n.n(o),i=n("5c96"),c=n("4360"),l=n("5f87"),u=s.a.create({baseURL:"/",timeout:1e4,withCredentials:!0});u.interceptors.request.use((function(e){return c["a"].getters.token&&(e.headers["X-Token"]=Object(l["a"])()),e}),(function(e){console.log("interceptors ",e);var t=2,n=function(){var o=Object(r["a"])(Object(a["a"])().mark((function r(){var o,s;return Object(a["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:return a.prev=0,o=e.config,a.next=4,u(o);case 4:return s=a.sent,a.abrupt("return",Promise.resolve(s));case 8:if(a.prev=8,a.t0=a["catch"](0),!(t>0)){a.next=15;break}return console.warn("Error occurred, retrying (".concat(t,"/").concat(t,")...")),a.abrupt("return",n());case 15:return a.abrupt("return",Promise.reject(a.t0));case 16:case"end":return a.stop()}}),r,null,[[0,8]])})));return function(){return o.apply(this,arguments)}}();return new Promise((function(e,t){n().then((function(t){e(t)})).catch((function(e){t(e)}))}))})),u.interceptors.response.use((function(e){var t=e.data;return 200!==t.code?(Object(i["Message"])({message:t.msg||"Error",type:"error",duration:5e3}),50008!==t.code&&50012!==t.code&&50014!==t.code||i["MessageBox"].confirm("You have been logged out, you can cancel to stay on this page, or log in again","Confirm logout",{confirmButtonText:"Re-Login",cancelButtonText:"Cancel",type:"warning"}).then((function(){c["a"].dispatch("user/resetToken").then((function(){location.reload()}))})),Promise.reject(new Error(t.msg||"Error"))):t}),(function(e){return Object(i["Message"])({message:e.message,type:"error",duration:5e3}),Promise.reject(e)})),t["a"]=u},de21:function(e,t,n){"use strict";n.r(t);var a=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",[n("el-col",[n("el-row",[n("el-select",{attrs:{placeholder:"请选择 Group"},model:{value:e.selectedGroup,callback:function(t){e.selectedGroup=t},expression:"selectedGroup"}},e._l(e.groups,(function(e){return n("el-option",{key:e.name,attrs:{label:e.name,value:e.name}})})),1)],1),n("el-row",[n("el-upload",{ref:"upload",staticClass:"upload-class",attrs:{action:"/","show-file-list":!1,"on-change":e.handleChange,"on-preview":e.handlePreview,"on-remove":e.handleRemove,"auto-upload":!1}},[n("el-button",{attrs:{slot:"trigger",size:"small",type:"primary"},slot:"trigger"},[e._v("选取文件")]),n("el-button",{staticStyle:{"margin-left":"10px"},attrs:{size:"small",type:"success"},on:{click:e.submitUpload}},[e._v("上传到服务器")]),n("div",{staticClass:"el-upload__tip",attrs:{slot:"tip"},slot:"tip"},[e._v("只能上传jpg/png文件，且不超过500kb")])],1)],1)],1),n("el-col",[n("el-button",{on:{click:function(e){}}},[e._v("btn")])],1),n("el-col",[n("progress-item",{attrs:{sessions:e.uploadSessions},on:{uploadClick:e.ClickReUploadBtn,fetchSessions:e.fetchSessions}})],1)],1)},r=[],o=n("c7eb"),s=n("1da1"),i=(n("c740"),n("3ca3"),n("ddb0"),n("d3b7"),n("820e"),n("b0c0"),n("9678")),c=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",[n("el-table",{staticStyle:{width:"100%"},attrs:{data:e.sessions}},[n("el-table-column",{attrs:{label:"文件名",width:"220",sortable:""},scopedSlots:e._u([{key:"default",fn:function(t){return[n("el-popover",{attrs:{trigger:"hover",placement:"top"}},[n("el-tag",[e._v("group: "+e._s(t.row.file_info.storage.group||""))]),e._v(" "),n("br"),n("el-tag",[e._v("address: "+e._s(t.row.file_info.storage.server_addr||""))]),n("div",{staticClass:"name-wrapper",attrs:{slot:"reference"},slot:"reference"},[n("p",[e._v(e._s(t.row.file_info.name))])])],1)]}}])}),n("el-table-column",{attrs:{label:"进度",width:"300",sortable:""},scopedSlots:e._u([{key:"default",fn:function(e){return[n("el-progress",{attrs:{"text-inside":!1,percentage:parseFloat(e.row.upload_session.percent>=100?100:e.row.upload_session.percent.toFixed(1))}})]}}])}),n("el-table-column",{attrs:{label:"大小",prop:"upload_session.file_info.file_meta.size",width:"120",sortable:""},scopedSlots:e._u([{key:"default",fn:function(t){return[n("p",[e._v(e._s(e.formatFileSize(t.row.file_info.file_meta.size)))])]}}])}),n("el-table-column",{attrs:{label:"速度",prop:"speed",width:"120",sortable:""},scopedSlots:e._u([{key:"default",fn:function(t){return[n("p",[e._v(e._s(e.formatFileSize(parseFloat(t.row.speed)))+"/s")])]}}])}),n("el-table-column",{attrs:{label:"创建时间",width:"280",prop:"upload_session.cteated_time",sortable:""},scopedSlots:e._u([{key:"default",fn:function(t){return[n("i",{staticClass:"el-icon-time"}),n("span",{staticStyle:{"margin-left":"10px"}},[e._v(e._s(e.ptime(t.row.upload_session.cteated_time)))])]}}])}),n("el-table-column",{attrs:{label:"状态",width:"180",prop:"upload_session.status"}}),n("el-table-column",{attrs:{label:"操作"},scopedSlots:e._u([{key:"default",fn:function(t){return[n("el-button",{attrs:{size:"mini"},on:{click:function(n){return e.clickMethed(t.row)}}},[e._v(e._s("异常"==t.row.upload_session.status?"重新上传":"暂停"))]),n("el-button",{attrs:{size:"mini",type:"danger"},on:{click:function(n){return e.delsession(t.row.upload_session.id)}}},[e._v("删除")])]}}])})],1)],1)},l=[],u=(n("99af"),n("b680"),n("cadb")),d=n("4837"),p={props:["sessions"],data:function(){return{property:"value"}},methods:{formatFileSize:function(e){var t=["B","KB","MB","GB","TB"],n=0;while(e>1024&&n<t.length-1)e/=1024,n++;return"".concat(e.toFixed(2)).concat(t[n])},ptime:function(e){return Object(u["b"])(e)},clickMethed:function(e){"异常"==e.upload_session.status?this.$emit("uploadClick",e):console.log("暂停")},delsession:function(e){var t=this;return Object(s["a"])(Object(o["a"])().mark((function n(){return Object(o["a"])().wrap((function(n){while(1)switch(n.prev=n.next){case 0:t.$confirm("确定要删除吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((function(){Object(d["a"])({session_id:e}).then((function(){t.$emit("fetchSessions"),t.$message.success("删除成功")}))})).catch((function(){}));case 1:case"end":return n.stop()}}),n)})))()}}},f=p,h=n("2877"),b=Object(h["a"])(f,c,l,!1,null,null,null),m=b.exports,g=n("d17e");function v(e){return Object(g["a"])({url:"/api/beforupload",method:"post",data:e})}function _(e){return Object(g["a"])({url:"/api/reupload",method:"post",data:e})}function w(e){return Object(g["a"])({url:"/api/upload",headers:{"Content-Type":"multipart/form-data"},method:"post",data:e})}function k(e){return Object(g["a"])({url:"/api/merge",method:"post",timeout:12e4,data:e})}n("fb6a"),n("a15b");var j=n("69a0"),x=n.n(j);function y(e,t){return S.apply(this,arguments)}function S(){return S=Object(s["a"])(Object(o["a"])().mark((function e(t,n){var a,r,s,i,c,l,u,d,p;return Object(o["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:a=5242880,r=Math.ceil(t.size/a),s=[],i=[],c=0,l=Object(o["a"])().mark((function e(){var l,d,p,f,h;return Object(o["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:l=u*a,d=(u+1)*a>t.size?t.size:(u+1)*a,p=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice,f=p.call(t,l,d),i.push(f),h=new Promise((function(e,t){var n=new FileReader;n.onload=function(){var t=x.a.ArrayBuffer.hash(n.result);e(t)},n.onerror=function(){return t("Unable to generate MD5 hash")},n.readAsArrayBuffer(f)})),s.push(h),h.then((function(e){c++;var t=Math.round(c/r*100);n(t)}));case 8:case"end":return e.stop()}}),e)})),u=0;case 7:if(!(u<r)){e.next=12;break}return e.delegateYield(l(),"t0",9);case 9:u++,e.next=7;break;case 12:return e.next=14,Promise.all(s);case 14:return d=e.sent,p=x.a.hash(d.join("")),e.abrupt("return",{md5Values:d,fileSlices:i,chunks:r,totalMd5:p});case 17:case"end":return e.stop()}}),e)}))),S.apply(this,arguments)}var O=n("5c96"),z=(n("252a"),{components:{ProgressItem:m,Loading:O["Loading"]},data:function(){return{uploadSessions:[],fileList:[],reqdata:{},groups:[],selectedGroup:"",blockStatus:[],reUploadFileInfo:null,loading:!1,loadingText:""}},mounted:function(){},created:function(){var e=this;this.timerUtil=new i["a"],this.fetchData(),this.fetchSessions(),this.timerUtil.addTimer((function(){e.fetchData()}),6e4),this.timerUtil.addTimer((function(){e.fetchSessions()}),6e4)},methods:{uploadblocks:function(e,t,n){var a=this;return Object(s["a"])(Object(o["a"])().mark((function r(){var s,i,c,l,u,d,p,f,h;return Object(o["a"])().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return s=5,r.next=3,a.fetchSessions();case 3:i=0,0,c=Date.now(),l=[],u=a.uploadSessions.findIndex((function(t){return t.upload_session.id==e})),d=a.uploadSessions[u],p=Object(o["a"])().mark((function r(p){var f,h;return Object(o["a"])().wrap((function(r){while(1)switch(r.prev=r.next){case 0:if(!t[p]){r.next=2;break}return r.abrupt("return","continue");case 2:if(f=new FormData,f.append("session_id",e),f.append("block_seq",p),f.append("file",n[p]),h=w(f),l.push(h),!(l.length>=s||p===t.length-1)){r.next=14;break}return r.next=11,Promise.allSettled(l);case 11:d.speed=n[p].size*s/(Date.now()-c)*1e3,c=Date.now(),l.length=0;case 14:h.then((function(e){i+=n[p].size,console.log(p,"+ filesize",i,"\nres:",e),d.upload_session.percent+=1/t.length*100,a.$set(a.uploadSessions,u,d)})).catch((function(e){console.log(e)}));case 15:case"end":return r.stop()}}),r)})),f=0;case 11:if(!(f<t.length)){r.next=19;break}return r.delegateYield(p(f),"t0",13);case 13:if(h=r.t0,"continue"!==h){r.next=16;break}return r.abrupt("continue",16);case 16:f++,r.next=11;break;case 19:return r.next=21,Promise.all(l);case 21:return r.next=23,k({session_id:""+e,size:i,block_size:t.length}).then((function(e){console.log("Merge : ",e),a.fetchSessions(),a.$message.success("上传成功！")}));case 23:case"end":return r.stop()}}),r)})))()},handleChange:function(e,t){var n=this;return Object(s["a"])(Object(o["a"])().mark((function t(){var a,r,s,i;return Object(o["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return console.log(e),a={group:n.selectedGroup,filename:e.name,size:e.size,mod_time:e.raw.lastModified,type:e.raw.type},r={file_info:{name:a.filename,file_meta:{size:a.size},storage:{group:a.group}},upload_session:{status:"预处理",percent:0}},n.uploadSessions.unshift(r),s=0,t.next=7,y(e.raw,(function(e){r.upload_session.percent=e,n.$set(n.uploadSessions,s,r)})).then((function(e){return console.log("处理完成",e),e}));case 7:if(i=t.sent,a.block_size=i.chunks,a.block_md5s=i.md5Values,a.md5=i.totalMd5,null==n.reUploadFileInfo){t.next=19;break}if(a.md5==n.reUploadFileInfo.file_info.file_meta.md5&&a.filename==n.reUploadFileInfo.file_info.name){t.next=15;break}return n.$message.error("文件不相同"),t.abrupt("return");case 15:return a.group=n.reUploadFileInfo.file_info.storage.group,t.next=18,_({block_md5s:a.block_md5s,session_id:n.reUploadFileInfo.upload_session.id}).then((function(e){n.uploadblocks(n.reUploadFileInfo.upload_session.id,e.data.data,i.fileSlices)})).catch((function(e){console.log(e),n.uploadSessions.shift()})).finally((function(){n.reUploadFileInfo=null}));case 18:return t.abrupt("return");case 19:return t.next=21,v(a).then((function(e){n.blockStatus=e.data.data.blocks,console.log("block status",n.blockStatus),n.uploadblocks(e.data.data.session_id,e.data.data.blocks,i.fileSlices)})).catch((function(e){n.uploadSessions.shift(),console.log(e)}));case 21:case"end":return t.stop()}}),t)})))()},submitUpload:function(){this.$refs.upload.submit()},handleRemove:function(e,t){console.log(e,t)},handlePreview:function(e){console.log(e)},fetchData:function(){var e=this;Object(d["b"])().then((function(t){e.groups=t.data.data.groups}))},fetchSessions:function(){var e=this;return Object(s["a"])(Object(o["a"])().mark((function t(){return Object(o["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,Object(d["d"])("上传成功").then((function(t){e.uploadSessions=t.data.data}));case 2:case"end":return t.stop()}}),t)})))()},ClickReUploadBtn:function(e){this.reUploadFileInfo=e;var t=this.$refs.upload.$el.querySelector(".el-upload__input");t.click()}}}),F=z,M=Object(h["a"])(F,a,r,!1,null,"5881d6e0",null);t["default"]=M.exports}}]);